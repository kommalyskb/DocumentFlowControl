@inherits LayoutComponentBase
@inject NavigationManager UriHelper
@inject LocalStorageHelper storageHelper
@inject IMinioService minio

<PageTitle>DFM.Frontend</PageTitle>
<MudThemeProvider Theme="customTheme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudLayout>
    @*<header class="mud-appbar mud-appbar-dense mud-elevation-4 mud-theme-primary">
        <div class="mud-toolbar mud-toolbar-dense mud-toolbar-gutters mud-toolbar-appbar" style="text-align: center; background-color: #20629b;">
            <img src="images/cse-logo.png" alt="logo" class="mud-image object-cover object-center mud-elevation-25 rounded-lg" width="45" height="45" style="margin: auto" />
        </div>
    </header>*@

    <MudAppBar Fixed="false">
        <MudImage Src="images/cse-logo.png" Alt="logo" Height="45" Width="45" Class="mr-2" />
        <MudText>CSE's Document Control</MudText>
        
        <MudSpacer />
        @if (employee != null)
        {
            if(employee.ProfileImage != null)
            {
                <MudImage Src="@imageUri" Alt="photo" Height="45" Width="45" Class="mr-2"/>
            }
            <MudText Class="mr-2">@employee.Name.Local @employee.FamilyName.Local</MudText>
            <MudButton Href="/authorize"
                       Variant="Variant.Text"
                       EndIcon="@Icons.Material.Outlined.Logout"
                       Style="text-transform:none; color:white; font-weight:bold">
                ອອກຈາກລະບົບ
            </MudButton>
        }
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen" Elevation="0" ClipMode="DrawerClipMode.Always" Variant="@DrawerVariant.Mini">

        <NavMenu OpenDrawer="ToggleMenu" IsOpen="@_drawerOpen" />
    </MudDrawer>
    <MudMainContent>
        @*@Body*@
        <CustomAuthorizeView>
            <Authorized>
                @Body
            </Authorized>
            <NotAuthorized>
                @{
                    UriHelper.NavigateTo("/authorize");
                }
            </NotAuthorized>
        </CustomAuthorizeView>

    </MudMainContent>

</MudLayout>


@code
{
    string? imageUri = "images/user.png";
    private EmployeeModel? employee;
    bool _drawerOpen = true;
    private MudTheme customTheme = new()
        {
            Palette = new Palette
            {
                Primary = "#002f57",
                //Secondary = "#3D9970",
                //Info = "#001f3f",
                //Success = "#2ECC40",
                //Warning = "#FF851B",
                //Error = "#F012BE",
                AppbarBackground = "#20629b"
                // more color properties
            }
        };
    void ToggleMenu()
    {
        _drawerOpen = !_drawerOpen;
    }

    protected override async Task OnInitializedAsync()
    {
        if (employee == null)
        {
            employee = await storageHelper.GetEmployeeProfileAsync();
            if (employee != null)
            {
                if (employee.ProfileImage != null)
                {
                    await previewImageProfile(employee.ProfileImage.Bucket, employee.ProfileImage.FileName);

                }
            }

        }
        else
        {
            if (employee.ProfileImage != null)
            {
                await previewImageProfile(employee.ProfileImage.Bucket, employee.ProfileImage.FileName);

            }
        }
    }
    private async Task previewImageProfile(string bucket, string fileName)
    {
        // Generate link
        var link = await minio.GenerateLink(bucket, fileName);
        if (link.IsSuccess)
        {
            imageUri = link.Response;
        }

    }
}
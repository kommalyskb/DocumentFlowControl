@inherits LayoutComponentBase
@inject NavigationManager UriHelper
@inject LocalStorageHelper storageHelper
@inject IMinioService minio
@inject EnvConf envConf
@inject ServiceEndpoint endpoint

<PageTitle>DFM.Frontend</PageTitle>
<MudThemeProvider Theme="customTheme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudLayout>

    <MudAppBar Fixed="true">
        <MudImage Src="@envConf.LogoUrl" Alt="logo" Height="45" Width="45" Class="mr-2 rounded-lg" ObjectFit="ObjectFit.Cover" />
        <MudText>@envConf.PageTitle</MudText>
        
        <MudSpacer />
        @if (employee != null)
        {
            if(employee.ProfileImage != null)
            {
                
                <MudImage Src="@imageUri" Alt="photo" Height="45" Width="45" Class="mr-2 rounded-lg" ObjectFit="ObjectFit.Cover" />
            }
            <MudText Class="mr-2">@employee.Name.Local @employee.FamilyName.Local</MudText>
            <MudButton Href="/authorize"
                       Variant="Variant.Text"
                       EndIcon="@Icons.Material.Outlined.Logout"
                       Style="text-transform:none; color:white; font-weight:bold">
                ອອກຈາກລະບົບ
            </MudButton>
        }
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen" Elevation="0" ClipMode="DrawerClipMode.Always" Variant="@DrawerVariant.Mini">

        <NavMenu OpenDrawer="ToggleMenu" IsOpen="@_drawerOpen" />
    </MudDrawer>
    <MudMainContent Class="mt-4">
        @*@Body*@
        <CustomAuthorizeView>
            <Authorized>
                @Body
            </Authorized>
            <NotAuthorized>
                @{
                    UriHelper.NavigateTo("/authorize");
                }
            </NotAuthorized>
        </CustomAuthorizeView>

    </MudMainContent>

</MudLayout>


@code
{
    string? imageUri = "images/user.png";
    private EmployeeModel? employee;
    bool _drawerOpen = true;
    private MudTheme customTheme = new()
        {
            Palette = new Palette
            {
                Primary = "#002f57",
                //Secondary = "#3D9970",
                //Info = "#001f3f",
                //Success = "#2ECC40",
                //Warning = "#FF851B",
                //Error = "#F012BE",
                AppbarBackground = "#20629b"
                // more color properties
            }
        };
    void ToggleMenu()
    {
        _drawerOpen = !_drawerOpen;
    }

    protected override async Task OnInitializedAsync()
    {
        if (employee == null)
        {
            employee = await storageHelper.GetEmployeeProfileAsync();
            if (employee != null)
            {
                if (employee.ProfileImage != null)
                {
                    await previewImageProfile(employee.ProfileImage.Bucket, employee.ProfileImage.FileName);

                }
            }

        }
        else
        {
            if (employee.ProfileImage != null)
            {
                await previewImageProfile(employee.ProfileImage.Bucket, employee.ProfileImage.FileName);

            }
        }
    }
    private async Task previewImageProfile(string bucket, string fileName)
    {
        // get file obj
        var obj = await minio.GenerateLink(bucket, fileName);
        if (obj.IsSuccess)
        {
            //imageUri = link.Response.Replace(endpoint.MinioAPI, endpoint.StorageAPI);
            imageUri = obj.Response;//$"data:image/png;base64,{obj.ByteStream.ToBase64()}";
        }

    }
}